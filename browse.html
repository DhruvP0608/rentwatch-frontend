<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Browse Complaints - RentWatch BLR</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    :root {
      --blue: #007bff;
      --green: #16a34a;
      --muted: #f0f3f6;
      --card-bg: #fff;
      --accent: #0b63ff;
      --radius: 16px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, Helvetica, sans-serif;
      background: #f5f7fa;
      color: #1f2937;
    }

    /* NAVBAR */
    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 14px 22px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(3,7,18,0.06);
      position: sticky;
      top: 0;
      z-index: 1000;
      flex-wrap: wrap;
    }
    .logo {
      font-weight: 700;
      color: #0b5ef5;
      text-decoration: none;
      font-size: 1.3rem;
    }
    .nav-links {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .nav-links a {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      background: var(--muted);
      border-radius: 22px;
      text-decoration: none;
      color: #111;
      font-weight: 600;
      font-size: 0.95rem;
      box-shadow: none;
      transition: transform .18s ease;
    }
    .nav-links a:hover {
      transform: translateY(-1px);
    }

    .nav-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .bubble-btn {
      padding: 8px 16px;
      border-radius: 22px;
      border: none;
      cursor: pointer;
      font-weight: 700;
      color: #fff;
      box-shadow: 0 4px 10px rgba(15,23,42,0.06);
    }
    .bubble-btn.tenant { background: var(--blue); }
    .bubble-btn.landlord { background: var(--green); }

    .auth-btn {
      background: linear-gradient(90deg, #3b82f6, #2563eb);
      color: #fff;
      border-radius: 12px;
      padding: 8px 16px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.25s ease;
      box-shadow: 0 3px 8px rgba(37, 99, 235, 0.25);
    }
    .auth-btn.logout {
      background: linear-gradient(90deg, #ef4444, #dc2626);
      box-shadow: 0 3px 8px rgba(220, 38, 38, 0.25);
    }

    .hero {
      padding: 48px 20px;
      text-align: center;
      background: linear-gradient(90deg, var(--blue), var(--green));
      color: #fff;
    }
    .hero h1 {
      margin: 0;
      font-size: 2.6rem;
      font-weight: 800;
    }

    .complaints-wrap {
      padding: 28px 28px 80px;
      display: flex;
      justify-content: center;
    }
    .complaints-grid {
      width: 100%;
      max-width: 1180px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 22px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: 0 10px 30px rgba(11,22,45,0.06);
      position: relative;
      overflow: hidden;
      border-top: 6px solid var(--blue);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 18px 36px rgba(11,22,45,0.08);
    }

    .empty {
      padding: 40px;
      text-align: center;
      color: #6b7280;
      font-size: 1.05rem;
    }

    .card-footer {
      display: flex;
      justify-content: flex-start;
      gap: 12px;
      margin-top: 10px;
    }
    .likeBtn, .dislikeBtn {
      background: #f3f4f6;
      border: none;
      border-radius: 20px;
      padding: 6px 12px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s ease;
    }
    .likeBtn:hover { background: #e0f2fe; }
    .dislikeBtn:hover { background: #fee2e2; }

    footer {
      padding: 26px;
      text-align: center;
      color: #6b7280;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>

  <nav class="navbar">
    <a class="logo" href="/rentwatch-frontend/index.html">RentWatch BLR</a>
    <div class="nav-links">
      <a href="/rentwatch-frontend/index.html"><i class="fas fa-house"></i> Home</a>
      <a href="/rentwatch-frontend/browse.html"><i class="fas fa-folder-open"></i> Browse Complaints</a>
      <a href="/rentwatch-frontend/notifications.html"><i class="fas fa-bell"></i> Notifications</a>
      <a href="/rentwatch-frontend/forum.html"><i class="fas fa-comments"></i> Forum</a>
      <a href="/rentwatch-frontend/resources.html"><i class="fas fa-book"></i> Resources</a>
    </div>
    <div class="nav-actions">
      <button class="bubble-btn tenant" onclick="checkRoleAndNavigate('tenant','/rentwatch-frontend/tenant-complaint.html')">Tenant Complaint</button>
      <button class="bubble-btn landlord" onclick="checkRoleAndNavigate('landlord','/rentwatch-frontend/landlord-complaint.html')">Landlord Complaint</button>
      <button id="authBtn" class="auth-btn">Login</button>
    </div>
  </nav>

  <section class="hero">
    <h1>Browse Complaints</h1>
    <p>Explore issues raised by tenants and landlords across Bangalore.</p>
  </section>

  <main class="complaints-wrap">
    <div class="complaints-grid" id="complaintsGrid"></div>
  </main>

  <footer>¬© 2025 RentWatch BLR ¬∑ Building a Fairer Bangalore</footer>

  <script>
  const BACKEND_URL = "https://rentwatch-backend.onrender.com";

  // --- AUTH BUTTON LOGIC ---
  (function () {
    const authBtn = document.getElementById('authBtn');
    function refreshAuth() {
      const token = localStorage.getItem('rw_token');
      if (token) {
        authBtn.textContent = 'Logout';
        authBtn.classList.add('logout');
        authBtn.onclick = (e) => {
          e.preventDefault();
          localStorage.removeItem('rw_token');
          window.location.reload();
        };
      } else {
        authBtn.textContent = 'Login';
        authBtn.classList.remove('logout');
        authBtn.onclick = () => window.location.href = '/rentwatch-frontend/login.html';
      }
    }
    refreshAuth();
  })();

  // --- DATE FORMATTER ---
  function formatDate(d) {
    if (!d) return "Unknown";
    const dt = new Date(d);
    if (isNaN(dt)) return "Unknown";
    return dt.toLocaleString();
  }

  // --- RENDER COMPLAINTS ---
  async function renderComplaints() {
    const grid = document.getElementById('complaintsGrid');
    grid.innerHTML = '<div class="empty">Loading complaints...</div>';

    try {
      const res = await fetch(`${BACKEND_URL}/api/public/complaints`);
      if (!res.ok) throw new Error('Failed to load complaints');
      const complaints = await res.json();

      if (!complaints.length) {
        grid.innerHTML = '<div class="empty">No complaints yet ‚Äî be the first to file one.</div>';
        return;
      }

      grid.innerHTML = '';
      complaints.forEach(c => {
        const id = c._id || c.id || '';
        const likes = c.likes || 0;
        const dislikes = c.dislikes || 0;
        const statusHTML =
          c.verified
            ? '<span style="color:#16a34a;">Resolved ‚úÖ</span>'
            : c.resolvedAt && !c.verified
              ? '<span style="color:#2563eb;">Awaiting Verification ‚è≥</span>'
              : '<span style="color:#dc2626;">Pending üî¥</span>';

        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <h3><i class="fa-solid ${c.role === 'tenant' ? 'fa-user' : 'fa-building'}"></i> ${c.role === 'tenant' ? 'Tenant' : 'Landlord'} Complaint</h3>
          <div style="font-weight:600;font-size:1.1rem;margin:4px 0;">${c.issueType || 'No title'}</div>
          <div class="desc" style="margin-bottom:6px;">${c.description || 'No description provided.'}</div>
          <small>Filed on: ${formatDate(c.date || c.createdAt)}</small>
          <div class="status" style="margin-top:6px;font-weight:600;">${statusHTML}</div>

          <div class="card-footer">
            <button class="likeBtn"><i class="fa-regular fa-thumbs-up"></i> ${likes}</button>
            <button class="dislikeBtn"><i class="fa-regular fa-thumbs-down"></i> ${dislikes}</button>
          </div>
        `;

        // like
        card.querySelector('.likeBtn').addEventListener('click', async () => {
          const token = localStorage.getItem('rw_token');
          if (!token) return alert("Please log in to like a complaint.");
          try {
            const res = await fetch(`${BACKEND_URL}/api/complaints/${id}/like`, {
              method: 'POST',
              headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.ok) renderComplaints();
            else {
              const err = await res.json();
              alert(err.error || 'Error liking complaint');
            }
          } catch (err) {
            console.error(err);
            alert('Network error while liking.');
          }
        });

        // dislike
        card.querySelector('.dislikeBtn').addEventListener('click', async () => {
          const token = localStorage.getItem('rw_token');
          if (!token) return alert("Please log in to dislike a complaint.");
          try {
            const res = await fetch(`${BACKEND_URL}/api/complaints/${id}/dislike`, {
              method: 'POST',
              headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.ok) renderComplaints();
            else {
              const err = await res.json();
              alert(err.error || 'Error disliking complaint');
            }
          } catch (err) {
            console.error(err);
            alert('Network error while disliking.');
          }
        });

        grid.appendChild(card);
      });
    } catch (err) {
      console.error(err);
      grid.innerHTML = '<div class="empty">Error loading complaints. Try again later.</div>';
    }
  }

  renderComplaints();

  // --- ROLE CHECK NAVIGATION ---
  function checkRoleAndNavigate(requiredRole, destination) {
    const token = localStorage.getItem('rw_token');
    if (!token) return window.location.href = '/rentwatch-frontend/login.html';
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      if (payload.role !== requiredRole) {
        alert(`You must be logged in as a ${requiredRole} to access this page.`);
        return;
      }
      window.location.href = destination;
    } catch {
      window.location.href = '/rentwatch-frontend/login.html';
    }
  }
  </script>
</body>
</html>
